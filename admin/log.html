<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>smash logs</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .log-controls {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }
        .log-controls select,
        .log-controls input,
        .log-controls button {
            padding: 8px 12px;
            border-radius: 5px;
            border: 1px solid var(--accent);
            background: var(--card-bg);
            color: var(--text);
            font-size: 14px;
        }
        .log-controls button {
            background: var(--accent);
            cursor: pointer;
            border: 1px solid var(--accent);
        }
        .log-controls button:hover {
            background: var(--accent-dark);
            border-color: var(--accent);
        }
        .log-controls label {
            color: var(--text-muted);
        }
        .log-output {
            background: #1e1e1e;
            border-radius: 8px;
            padding: 15px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.5;
            overflow-x: auto;
            max-height: 70vh;
            overflow-y: auto;
        }
        .log-line {
            margin: 2px 0;
            white-space: pre-wrap;
            word-break: break-all;
        }
        .log-line.info { color: #abb2bf; }
        .log-line.warning { color: #e5c07b; }
        .log-line.error { color: #e06c75; }
        .log-line.sms { color: #98c379; }
        .status {
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
        }
        .status.loading { background: var(--card-bg); color: var(--accent); }
        .status.error { background: #3d2020; color: #e06c75; }
        .status.success { background: #203d20; color: #98c379; }
        .endpoint-config {
            margin-bottom: 20px;
        }
        .endpoint-config input {
            width: 100%;
            max-width: 500px;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid var(--border);
            background: var(--card-bg);
            color: var(--text);
            font-family: 'Consolas', monospace;
        }
        .auto-refresh {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .auto-refresh input[type="checkbox"] {
            width: 18px;
            height: 18px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>smash logs</h1>
        
        <nav class="nav">
            <a href="index.html">Dashboard</a>
            <a href="help.html">Command Reference</a>
            <a href="log.html">Logs</a>
        </nav>

        <div class="endpoint-config">
            <label for="endpoint">Log Endpoint URL:</label><br>
            <input type="text" id="endpoint" placeholder="https://xxxxx.execute-api.us-west-2.amazonaws.com/smash-log-receiver">
            <p style="color: var(--text-muted); font-size: 12px; margin-top: 5px;">
                This is the API Gateway URL for your smash-log-receiver Lambda. Save it in localStorage.
            </p>
        </div>

        <div class="log-controls">
            <div>
                <label for="device">Device:</label>
                <select id="device">
                    <option value="">Loading...</option>
                </select>
            </div>
            <div>
                <label for="limit">Lines:</label>
                <input type="number" id="limit" value="100" min="10" max="500" style="width: 80px;">
            </div>
            <button id="refresh">‚ü≥ Refresh</button>
            <div class="auto-refresh">
                <input type="checkbox" id="autoRefresh">
                <label for="autoRefresh">Auto-refresh (30s)</label>
            </div>
        </div>

        <div id="status" class="status" style="display: none;"></div>

        <div class="log-output" id="logOutput">
            <div class="log-line info">Configure your endpoint URL above and click Refresh to load logs.</div>
        </div>
    </div>

    <script>
        const endpointInput = document.getElementById('endpoint');
        const deviceSelect = document.getElementById('device');
        const limitInput = document.getElementById('limit');
        const refreshBtn = document.getElementById('refresh');
        const autoRefreshCheckbox = document.getElementById('autoRefresh');
        const statusDiv = document.getElementById('status');
        const logOutput = document.getElementById('logOutput');

        let autoRefreshInterval = null;

        // Load saved endpoint from localStorage
        const savedEndpoint = localStorage.getItem('smash-log-endpoint');
        if (savedEndpoint) {
            endpointInput.value = savedEndpoint;
            loadDevices();
        }

        // Save endpoint on change
        endpointInput.addEventListener('change', () => {
            localStorage.setItem('smash-log-endpoint', endpointInput.value);
            loadDevices();
        });

        refreshBtn.addEventListener('click', loadLogs);
        deviceSelect.addEventListener('change', loadLogs);

        autoRefreshCheckbox.addEventListener('change', () => {
            if (autoRefreshCheckbox.checked) {
                autoRefreshInterval = setInterval(loadLogs, 30000);
            } else {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
        });

        async function loadDevices() {
            const endpoint = endpointInput.value.trim();
            if (!endpoint) return;

            showStatus('Loading devices...', 'loading');
            
            try {
                const response = await fetch(endpoint);
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }

                deviceSelect.innerHTML = '';
                
                if (data.devices && data.devices.length > 0) {
                    data.devices.forEach(d => {
                        const option = document.createElement('option');
                        option.value = d.name;
                        option.textContent = d.name + (d.lastEvent ? ` (${formatTime(d.lastEvent)})` : '');
                        deviceSelect.appendChild(option);
                    });
                    hideStatus();
                    loadLogs();
                } else {
                    deviceSelect.innerHTML = '<option value="">No devices found</option>';
                    showStatus('No devices found. Has the app sent any logs?', 'error');
                }
            } catch (error) {
                showStatus('Error loading devices: ' + error.message, 'error');
                deviceSelect.innerHTML = '<option value="">Error loading</option>';
            }
        }

        async function loadLogs() {
            const endpoint = endpointInput.value.trim();
            const device = deviceSelect.value;
            const limit = parseInt(limitInput.value) || 100;

            if (!endpoint) {
                showStatus('Please enter your log endpoint URL', 'error');
                return;
            }

            if (!device) {
                return;
            }

            showStatus('Loading logs...', 'loading');

            try {
                const url = `${endpoint}?device=${encodeURIComponent(device)}&limit=${limit}`;
                const response = await fetch(url);
                const data = await response.json();

                if (data.error) {
                    throw new Error(data.error);
                }

                if (data.logs && data.logs.length > 0) {
                    renderLogs(data.logs);
                    showStatus(`Loaded ${data.logs.length} log entries`, 'success');
                    setTimeout(hideStatus, 2000);
                } else {
                    logOutput.innerHTML = '<div class="log-line info">No logs found for this device.</div>';
                    hideStatus();
                }
            } catch (error) {
                showStatus('Error loading logs: ' + error.message, 'error');
            }
        }

        function renderLogs(logs) {
            logOutput.innerHTML = logs.map(line => {
                let level = 'info';
                if (line.includes('[error]')) level = 'error';
                else if (line.includes('[warning]')) level = 'warning';
                else if (line.includes('[SMS]')) level = 'sms';
                
                return `<div class="log-line ${level}">${escapeHtml(line)}</div>`;
            }).join('');
            
            // Scroll to bottom
            logOutput.scrollTop = logOutput.scrollHeight;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatTime(isoString) {
            const date = new Date(isoString);
            return date.toLocaleString();
        }

        function showStatus(message, type) {
            statusDiv.textContent = message;
            statusDiv.className = 'status ' + type;
            statusDiv.style.display = 'block';
        }

        function hideStatus() {
            statusDiv.style.display = 'none';
        }
    </script>
</body>
</html>
